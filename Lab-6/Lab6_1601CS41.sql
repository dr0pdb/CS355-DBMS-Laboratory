DROP DATABASE IF EXISTS LAB6;

CREATE DATABASE LAB6;

USE LAB6;

CREATE TABLE BRANCH
(
	branch_id VARCHAR(25) PRIMARY KEY,
	branch_name VARCHAR(25) UNIQUE,
	branch_city VARCHAR(25),
	assets VARCHAR(25) NOT NULL,
	modified_date DATE
);

CREATE TABLE ACCOUNT
(
	account_id VARCHAR(25) PRIMARY KEY,
	branch_id VARCHAR(25),
	account_number VARCHAR(25),
	account_type VARCHAR(25),
	balance FLOAT(10,2),
	modified_date DATE,
	FOREIGN KEY (branch_id) REFERENCES BRANCH(branch_id)
);

CREATE TABLE CUSTOMER
(
	customer_id VARCHAR(25) PRIMARY KEY,
	name VARCHAR(25),
	street VARCHAR(25),
	city VARCHAR(25),
	state VARCHAR(25),
	zip VARCHAR(25),
	country VARCHAR(25),
	modified_date DATE
);

CREATE TABLE LOAN
(
	loan_id VARCHAR(25) PRIMARY KEY,
	account_id VARCHAR(25),
	branch_id VARCHAR(25),
	loan_number VARCHAR(25),
	loan_type ENUM('Personal', 'Home', 'Car'),
	amount FLOAT(10,2),
	modified_date DATE,
	FOREIGN KEY (account_id) REFERENCES ACCOUNT(account_id) ON DELETE CASCADE,
	FOREIGN KEY (branch_id) REFERENCES BRANCH(branch_id) ON DELETE CASCADE 
);

CREATE TABLE DEPOSITOR
(
	customer_id VARCHAR(25),
	account_id VARCHAR(25),
	modified_date DATE,
	PRIMARY KEY(customer_id, account_id),
	FOREIGN KEY (customer_id) REFERENCES CUSTOMER(customer_id) ON DELETE CASCADE,
	FOREIGN KEY (account_id) REFERENCES ACCOUNT(account_id) ON DELETE CASCADE
);

CREATE TABLE BORROWER
(
	customer_id VARCHAR(25),
	loan_id VARCHAR(25),
	modified_date DATE,
	PRIMARY KEY (customer_id, loan_id),
	FOREIGN KEY (customer_id) REFERENCES CUSTOMER(customer_id) ON DELETE CASCADE,
	FOREIGN KEY (loan_id) REFERENCES LOAN(loan_id)
);

CREATE TABLE TRANSACTION
(
	transaction_id VARCHAR(25) PRIMARY KEY,
	account_id VARCHAR(25),
	tran_type ENUM('Loan payment', 'Loan taken', 'Simple Deposit', 'Simple Withdraw'),
	amount FLOAT(10,2),
	modified_date DATE,
	FOREIGN KEY (account_id) REFERENCES ACCOUNT(account_id) ON DELETE CASCADE
);

/*
	Insertion of data.
*/
INSERT INTO BRANCH VALUES("B01","NARENGI","GUWAHATI",1000000,'2016-12-10');
INSERT INTO BRANCH VALUES("B02","BIHTA","PATNA",1034265,'2017-02-11');
INSERT INTO BRANCH VALUES("B03","ERNAKULAM","CHENNAI",2172361,'2016-11-15');
INSERT INTO BRANCH VALUES("B04","PARO","THIMPU",87342833,'2017-04-28');
INSERT INTO BRANCH VALUES("B05","BELTOLA","GUWAHATI",27347236,'2015-10-22');
INSERT INTO BRANCH VALUES("B06","RAJARHAT","KOLKATA",41231431,'2016-12-02');
INSERT INTO BRANCH VALUES("B07","HSR LAYOUT","BANGALORE",5123534,'2017-09-20');
INSERT INTO BRANCH VALUES("B08","POWAI","MUMBAI",4124333,'2017-02-12');
INSERT INTO BRANCH VALUES("B09","KIDWAI","KANPUR",63637721,'2017-05-14');
INSERT INTO BRANCH VALUES("B10","JAMMU","JAMMU",53415324,'2016-03-11');
INSERT INTO BRANCH VALUES("B11","GUMTI NAGAR","LUCKNOW",12653712,'2016-12-30');
INSERT INTO BRANCH VALUES("B12","GUWAHATI CLUB","GUWAHATI",37423451,'2017-07-07');
INSERT INTO BRANCH VALUES("B13","CHRISTIAN BASTI","GUWAHATI",7645273,'2016-07-29');

INSERT INTO ACCOUNT VALUES("A01","B01","283847222772","SAVINGS",344000,'2017-10-01');
INSERT INTO ACCOUNT VALUES("A02","B01","183847232782","SAVINGS",44000,'2017-09-03');
INSERT INTO ACCOUNT VALUES("A03","B01","483846522772","CURRENT",60300,'2017-09-30');
INSERT INTO ACCOUNT VALUES("A04","B02","383824722277","SAVINGS",544000,'2017-09-28');
INSERT INTO ACCOUNT VALUES("A05","B02","283451222772","CURRENT",34000,'2017-09-15');
INSERT INTO ACCOUNT VALUES("A06","B03","883842322772","SAVINGS",144000,'2017-10-02');
INSERT INTO ACCOUNT VALUES("A07","B03","983842122772","SAVINGS",300,'2017-08-12');
INSERT INTO ACCOUNT VALUES("A08","B04","783212122772","CURRENT",140050,'2017-08-13');
INSERT INTO ACCOUNT VALUES("A09","B05","683212122212","CURRENT",160250,'2017-09-13');
INSERT INTO ACCOUNT VALUES("A10","B06","583992122212","SAVINGS",1802501,'2017-09-23');
INSERT INTO ACCOUNT VALUES("A11","B07","383992129812","SAVINGS",182501,'2017-09-27');
INSERT INTO ACCOUNT VALUES("A12","B07","483992123312","CURRENT",54239,'2017-09-28');
INSERT INTO ACCOUNT VALUES("A13","B08","583992122212","SAVINGS",1802501,'2017-09-23');
INSERT INTO ACCOUNT VALUES("A14","B09","283992111112","SAVINGS",2802501,'2017-09-20');
INSERT INTO ACCOUNT VALUES("A15","B10","783992121132","CURRENT",3802501,'2017-09-12');
INSERT INTO ACCOUNT VALUES("A16","B10","483992122232","SAVINGS",1802501,'2017-09-19');
INSERT INTO ACCOUNT VALUES("A17","B10","483992129992","CURRENT",8802501,'2017-08-19');
INSERT INTO ACCOUNT VALUES("A18","B10","483992122111","SAVINGS",802501,'2017-10-03');
INSERT INTO ACCOUNT VALUES("A19","B12","283992112299","SAVINGS",2501,'2017-09-26');
INSERT INTO ACCOUNT VALUES("A20","B13","483992123216","CURRENT",1802,'2017-09-09');

INSERT INTO CUSTOMER VALUES("C01","SHAURYA","SUBHASH NAGAR","GUWAHATI","ASSAM",781171,"INDIA",'2017-04-03');
INSERT INTO CUSTOMER VALUES("C02","SARANSH","GEORGE STREET","MARGAO","GOA",780121,"INDIA",'2017-01-30');
INSERT INTO CUSTOMER VALUES("C03","ASHUTOSH","DHARAVI","MUMBAI","MAHARASHTRA",789171,"INDIA",'2017-02-27');
INSERT INTO CUSTOMER VALUES("C04","DEVANSH","DAHI WALI GALI","BHARATPUR","RAJASTHAN",782121,"INDIA",'2017-08-23');
INSERT INTO CUSTOMER VALUES("C05","SHIKHAR","KIDWAI NAGAR","KANPUR","UP",701101,"INDIA",'2017-09-13');
INSERT INTO CUSTOMER VALUES("C06","RAJ","ZOO ROAD","GUWAHATI","ASSAM",702181,"INDIA",'2017-10-03');
INSERT INTO CUSTOMER VALUES("C07","YASH","MAGISTRATE STREET","VARANASI","UP",781071,"INDIA",'2017-04-10');
INSERT INTO CUSTOMER VALUES("C08","SATHWIKESH","PALASH NAGAR","KOLKATA","WB",761575,"INDIA",'2017-07-29');
INSERT INTO CUSTOMER VALUES("C09","ASRAF","KORAMANGALA","BANGALORE","KARATAKA",721371,"INDIA",'2017-05-03');
INSERT INTO CUSTOMER VALUES("C10","PIYUSH","VIJAYNAGAR","VIJAYWADA","AP",791171,"INDIA",'2017-04-17');
INSERT INTO CUSTOMER VALUES("C11","PRAJJWAL","CONNAUGHT PALACE","DELHI","DELHI",780987,"INDIA",'2017-08-15');
INSERT INTO CUSTOMER VALUES("C12","SUARABH","RAJENDRA NAGAR","PATNA","BIHAR",771171,"INDIA",'2017-07-21');
INSERT INTO CUSTOMER VALUES("C13","SUCHIRA","MANIPAL","MANIPAL","KARNATAKA",761271,"INDIA",'2017-07-22');
INSERT INTO CUSTOMER VALUES("C14","ANIRUDH","OLIVE ESTATE","KOLKATA","WB",781474,"INDIA",'2017-05-28'); 

INSERT INTO LOAN VALUES("L01","A01","B01","13525252","PERSONAL",50000,'2017-10-03');
INSERT INTO LOAN VALUES("L02","A02","B01","67584322","HOME",344000,'2017-10-05');
INSERT INTO LOAN VALUES("L03","A04","B02","38382472","CAR",54000,'2017-10-04');
INSERT INTO LOAN VALUES("L04","A05","B02","28345122","PERSONAL",364000,'2017-10-04');
INSERT INTO LOAN VALUES("L05","A08","B04","78321212","PERSONAL",540050,'2017-10-02');
INSERT INTO LOAN VALUES("L06","A09","B05","68321212","HOME",1690250,'2017-10-03');
INSERT INTO LOAN VALUES("L07","A11","B07","38399212","CAR",1825019,'2017-10-03');
INSERT INTO LOAN VALUES("L08","A14","B09","28399211","HOME",1202501,'2017-10-04');
INSERT INTO LOAN VALUES("L09","A17","B10","48399212","PERSONAL",8802501,'2017-10-01');
INSERT INTO LOAN VALUES("L10","A01","B01","10000252","HOME",50000,'2017-10-04');
INSERT INTO LOAN VALUES("L11","A01","B01","13005252","CAR",50000,'2017-10-05');

INSERT INTO DEPOSITOR VALUES("C01",'A01','2017-04-04');
INSERT INTO DEPOSITOR VALUES("C02",'A02','2017-02-02');
INSERT INTO DEPOSITOR VALUES("C03","A03",'2017-07-05');
INSERT INTO DEPOSITOR VALUES("C03","A04",'2017-08-05');
INSERT INTO DEPOSITOR VALUES("C03","A05",'2017-09-05');
INSERT INTO DEPOSITOR VALUES("C04","A06",'2017-08-28');
INSERT INTO DEPOSITOR VALUES("C05","A07",'2017-09-29');
INSERT INTO DEPOSITOR VALUES("C06","A08",'2017-10-06');
INSERT INTO DEPOSITOR VALUES("C06","A09",'2017-10-05');
INSERT INTO DEPOSITOR VALUES("C06","A10",'2017-10-04');
INSERT INTO DEPOSITOR VALUES("C07","A11",'2017-04-10');
INSERT INTO DEPOSITOR VALUES("C08","A12",'2017-08-29');
INSERT INTO DEPOSITOR VALUES("C09","A13",'2017-07-03');
INSERT INTO DEPOSITOR VALUES("C09","A14",'2017-06-03');
INSERT INTO DEPOSITOR VALUES("C10","A15",'2017-07-21');
INSERT INTO DEPOSITOR VALUES("C11","A16",'2017-09-15');
INSERT INTO DEPOSITOR VALUES("C12","A17",'2017-07-22');
INSERT INTO DEPOSITOR VALUES("C12","A18",'2017-08-22');
INSERT INTO DEPOSITOR VALUES("C13","A19",'2017-08-28');
INSERT INTO DEPOSITOR VALUES("C14","A20",'2017-08-02'); 

INSERT INTO BORROWER VALUES("C01","L01",'2017-10-03');
INSERT INTO BORROWER VALUES("C02","L02",'2017-10-05');
INSERT INTO BORROWER VALUES("C03","L03",'2017-10-04');
INSERT INTO BORROWER VALUES("C03","L04",'2017-10-04');
INSERT INTO BORROWER VALUES("C06","L05",'2017-10-02');
INSERT INTO BORROWER VALUES("C06","L06",'2017-10-03');
INSERT INTO BORROWER VALUES("C07","L07",'2017-10-03');
INSERT INTO BORROWER VALUES("C09","L08",'2017-10-04');
INSERT INTO BORROWER VALUES("C12","L09",'2017-10-01');
INSERT INTO BORROWER VALUES("C01","L10",'2017-10-04');
INSERT INTO BORROWER VALUES("C01","L11",'2017-10-05');

INSERT INTO TRANSACTION VALUES("T01","A01","LOAN TAKEN",40000,'2017-10-06');
INSERT INTO TRANSACTION VALUES("T02","A01","SIMPLE WITHDRAW",400,'2017-10-06');
INSERT INTO TRANSACTION VALUES("T03","A01","SIMPLE WITHDRAW",4000,'2017-10-06');
INSERT INTO TRANSACTION VALUES("T04","A01","SIMPLE DEPOSIT",40000,'2017-10-06');
INSERT INTO TRANSACTION VALUES("T05","A01","SIMPLE WITHDRAW",40000,'2017-10-06');
INSERT INTO TRANSACTION VALUES("T06","A01","SIMPLE WITHDRAW",40000,'2017-10-06');
INSERT INTO TRANSACTION VALUES("T07","A01","SIMPLE WITHDRAW",40000,'2017-10-06');
INSERT INTO TRANSACTION VALUES("T08","A01","SIMPLE DEPOSIT",40000,'2017-10-06');
INSERT INTO TRANSACTION VALUES("T09","A01","SIMPLE WITHDRAW",40000,'2017-10-06');
INSERT INTO TRANSACTION VALUES("T10","A01","SIMPLE DEPOSIT",2910,'2017-10-06');
INSERT INTO TRANSACTION VALUES("T11","A01","SIMPLE DEPOSIT",40,'2017-10-06');
INSERT INTO TRANSACTION VALUES("T12","A01","SIMPLE DEPOSIT",500,'2017-10-06');
INSERT INTO TRANSACTION VALUES("T13","A01","LOAN TAKEN",50000,'2017-10-06');
INSERT INTO TRANSACTION VALUES("T14","A01","LOAN PAID",40000,'2017-10-06');
INSERT INTO TRANSACTION VALUES("T15","A01","LOAN TAKEN",60000,'2017-10-06');
INSERT INTO TRANSACTION VALUES("T16","A01","LOAN PAID",60000,'2017-10-06');
INSERT INTO TRANSACTION VALUES("T17","A01","LOAN PAID",50000,'2017-10-06');
INSERT INTO TRANSACTION VALUES("T18","A02","LOAN TAKEN",344000,'2017-10-06');
INSERT INTO TRANSACTION VALUES("T19","A04","LOAN TAKEN",54000,'2017-10-04');
INSERT INTO TRANSACTION VALUES("T20","A05","LOAN TAKEN",364000,'2017-10-04');
INSERT INTO TRANSACTION VALUES("T21","A08","LOAN TAKEN",540050,'2017-10-02');
INSERT INTO TRANSACTION VALUES("T22","A09","LOAN TAKEN",1690250,'2017-10-03');
INSERT INTO TRANSACTION VALUES("T23","A11","LOAN TAKEN",1825019,'2017-10-03');
INSERT INTO TRANSACTION VALUES("T24","A14","LOAN TAKEN",1202501,'2017-10-04');
INSERT INTO TRANSACTION VALUES("T25","A17","LOAN TAKEN",8802501,'2017-10-01');
INSERT INTO TRANSACTION VALUES("T26","A18","SIMPLE DEPOSIT",80500,'2017-10-05');
INSERT INTO TRANSACTION VALUES("T27","A17","SIMPLE DEPOSIT",501,'2017-10-05');
INSERT INTO TRANSACTION VALUES("T28","A17","SIMPLE DEPOSIT",2501,'2017-10-04');
INSERT INTO TRANSACTION VALUES("T29","A17","SIMPLE DEPOSIT",2500,'2017-10-03');
INSERT INTO TRANSACTION VALUES("T30","A17","SIMPLE WITHDRAW",500,'2017-10-04');
INSERT INTO TRANSACTION VALUES("T31","A17","SIMPLE DEPOSIT",5112,'2017-10-05');
INSERT INTO TRANSACTION VALUES("T32","A17","SIMPLE WITHDRAW",7684,'2017-10-02');

SELECT * FROM BRANCH;

SELECT * FROM ACCOUNT;

SELECT * FROM CUSTOMER;

SELECT * FROM LOAN;

SELECT * FROM DEPOSITOR;

SELECT * FROM BORROWER;

SELECT * FROM TRANSACTION;

/*
	Queries
*/
SET AUTOCOMMIT = 0;

/*
	1. Update the balance of those customers by decreasing 3% of their balance whose balance is below 3000.
*/
UPDATE ACCOUNT
SET balance = balance * 0.97
WHERE balance < 3000;
SELECT * FROM ACCOUNT;

/*
	2. Delete the entry of customer whose balance is below 500 and savepoint (sp1).
*/
DELETE FROM ACCOUNT
WHERE balance < 300;
SELECT * FROM ACCOUNT;
SAVEPOINT sp1;

/*
	3. List all the customer details who have taken atleast 2 loans.
*/
SELECT t1.customer_id, name, street, city, state, zip, country, t1.modified_date
FROM CUSTOMER t1 JOIN BORROWER t2 ON t1.customer_id = t2.customer_id
GROUP BY t1.customer_id
HAVING count(t1.customer_id) > 1;

/*
	4. Delete the customers who have taken all 3 type of loans.
*/
SET FOREIGN_KEY_CHECKS=0;
DELETE FROM CUSTOMER
WHERE customer_id IN (
	SELECT customer_id
	FROM BORROWER
	WHERE loan_id IN (SELECT loan_id FROM LOAN WHERE account_id IN (SELECT account_id FROM LOAN GROUP BY (account_id) HAVING COUNT(DISTINCT loan_type) = 3)));
SET FOREIGN_KEY_CHECKS=1;
SELECT * FROM CUSTOMER;
/*
	5. Execute rollback command till sp1 and commit.
*/
rollback to sp1;
commit;

/*
	6. Lock(read) the table Account and increase the balance of the customers by 5% whose balance > 10000.
*/
lock table ACCOUNT read;
update ACCOUNT SET balance = balance * 1.05 WHERE balance > 10000;

/*
	7. Unlock the Account table and apply write lock on the same table(account). Then increase the balance of the customers by 5% whose balance > 10000.
*/
unlock tables;
lock table ACCOUNT write;
UPDATE ACCOUNT SET balance = balance * 1.05 WHERE balance > 10000;
SELECT * FROM ACCOUNT;

/*
	8. Unlock all the tables.
*/
UNLOCK tables;